#!/bin/bash

# ะกะบัะธะฟั ะดะปั ะฝะฐัััะพะนะบะธ ะธะฝัะตะณัะฐัะธะธ ั ะปะตะฝะดะธะฝะณะพะผ PressVPN

echo "๐ ะะฐัััะพะนะบะฐ ะธะฝัะตะณัะฐัะธะธ PressVPN Bot ั ะปะตะฝะดะธะฝะณะพะผ..."

# ะัะพะฒะตัะบะฐ ะฝะฐะปะธัะธั .env ัะฐะนะปะฐ
if [ ! -f .env ]; then
    echo "๐ ะกะพะทะดะฐะฝะธะต .env ัะฐะนะปะฐ ะธะท ะฟัะธะผะตัะฐ..."
    cp .env.example .env
    echo "โ .env ัะฐะนะป ัะพะทะดะฐะฝ"
else
    echo "โ .env ัะฐะนะป ัะถะต ัััะตััะฒัะตั"
fi

# ะคัะฝะบัะธั ะดะปั ะพะฑะฝะพะฒะปะตะฝะธั ะฟะตัะตะผะตะฝะฝะพะน ะฒ .env
update_env() {
    local key=$1
    local value=$2
    if grep -q "^${key}=" .env; then
        sed -i.bak "s|^${key}=.*|${key}=${value}|" .env
    else
        echo "${key}=${value}" >> .env
    fi
}

# ะะฐะฟัะพั ะดะฐะฝะฝัั ั ะฟะพะปัะทะพะฒะฐัะตะปั
read -p "๐ ะะฒะตะดะธัะต ัััะปะบั ะฝะฐ ะณััะฟะฟั/ะบะฐะฝะฐะป ะฟะพะดะดะตัะถะบะธ Telegram (ะฝะฐะฟัะธะผะตั: https://t.me/pressvpn_support): " support_link
read -p "๐ ะะฒะตะดะธัะต ะดะพะผะตะฝ ะฒะฐัะตะณะพ ัะฐะนัะฐ (ะฝะฐะฟัะธะผะตั: pressvpn.shop): " domain

# ะะฑะฝะพะฒะปะตะฝะธะต ะฟะตัะตะผะตะฝะฝัั
echo "๐ ะะฑะฝะพะฒะปะตะฝะธะต ะฝะฐัััะพะตะบ..."
update_env "SUPPORT_LINK" "$support_link"
update_env "SERVER_STATUS_URL" "https://${domain}#status"
update_env "TERMS_OF_SERVICE_URL" "https://${domain}#terms"

echo "โ ะะฐัััะพะนะบะธ ะพะฑะฝะพะฒะปะตะฝั"

# ะกะพะทะดะฐะฝะธะต ะดะธัะตะบัะพัะธะน ะดะปั ัะฐะนัะพะฒ
echo ""
echo "๐ ะัะพะฒะตัะบะฐ ะดะธัะตะบัะพัะธะน ะดะปั ัะฐะนัะพะฒ..."

# ะัะฝะพะฒะฝะพะน ัะฐะนั
if [ ! -d "/var/www/pressvpn.shop" ]; then
    echo "๐ ะกะพะทะดะฐะฝะธะต ะดะธัะตะบัะพัะธะธ ะดะปั ะพัะฝะพะฒะฝะพะณะพ ัะฐะนัะฐ..."
    sudo mkdir -p /var/www/pressvpn.shop
    sudo mkdir -p /var/www/pressvpn.shop/terms
    echo "โ ะะธัะตะบัะพัะธะธ ัะพะทะดะฐะฝั"
else
    echo "โ ะะธัะตะบัะพัะธั ะพัะฝะพะฒะฝะพะณะพ ัะฐะนัะฐ ัััะตััะฒัะตั"
fi

# ะกัะฐััั ัะฐะนั (ะตัะปะธ ะพัะดะตะปัะฝัะน ะดะพะผะตะฝ)
if [[ $use_status_domain == "y" || $use_status_domain == "Y" ]]; then
    if [ ! -d "/var/www/status.pressvpn.shop" ]; then
        echo "๐ ะกะพะทะดะฐะฝะธะต ะดะธัะตะบัะพัะธะธ ะดะปั ัะฐะนัะฐ ััะฐัััะฐ..."
        sudo mkdir -p /var/www/status.pressvpn.shop
        echo "โ ะะธัะตะบัะพัะธั ััะฐัััะฐ ัะพะทะดะฐะฝะฐ"
    fi
fi

# ะัะพะฒะตัะบะฐ docker-compose
if ! command -v docker-compose &> /dev/null; then
    echo "โ๏ธ  docker-compose ะฝะต ัััะฐะฝะพะฒะปะตะฝ. ะฃััะฐะฝะพะฒะธัะต ะตะณะพ ะดะปั ะฟัะพะดะพะปะถะตะฝะธั."
    exit 1
fi

echo ""
echo "โ๏ธ  ะะะะะซะ ะะะะะะะะะะะฏ:"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "1. YooKassa ะฝะฐัะพะดะธััั ะฒ ะขะะกะขะะะะ ัะตะถะธะผะต!"
echo "   ะะฐะผะตะฝะธัะต ะบะปััะธ ะฝะฐ ะฑะพะตะฒัะต ะฒ .env:"
echo "   YOOKASSA_SHOP_ID ะธ YOOKASSA_SECRET_KEY"
echo ""
echo "2. ะะฐะทะผะตััะธัะต HTML ัะฐะนะปั:"
echo "   โข ะัะฝะพะฒะฝะพะน ัะฐะนั: /var/www/pressvpn.shop/index.html"
echo "   โข ะฃัะปะพะฒะธั: /var/www/pressvpn.shop/terms/index.html"
if [[ $use_status_domain == "y" || $use_status_domain == "Y" ]]; then
    echo "   โข ะกัะฐััั: /var/www/status.pressvpn.shop/index.html"
fi
echo ""
echo "3. ะะฐัััะพะนัะต nginx ะดะปั ะดะพะผะตะฝะพะฒ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

# ะัะตะดะปะพะถะตะฝะธะต ะฟะตัะตะทะฐะฟัััะธัั ะบะพะฝัะตะนะฝะตัั
echo ""
read -p "๐ ะะตัะตะทะฐะฟัััะธัั ะบะพะฝัะตะนะฝะตัั ะดะปั ะฟัะธะผะตะฝะตะฝะธั ะฝะฐัััะพะตะบ? (y/n): " restart
if [[ $restart == "y" || $restart == "Y" ]]; then
    echo "๐ ะะตัะตะทะฐะฟััะบ ะบะพะฝัะตะนะฝะตัะพะฒ..."
    docker-compose down
    docker-compose up -d
    echo "โ ะะพะฝัะตะนะฝะตัั ะฟะตัะตะทะฐะฟััะตะฝั"
    
    echo ""
    echo "๐ ะกัะฐััั ะบะพะฝัะตะนะฝะตัะพะฒ:"
    docker-compose ps
fi

echo ""
echo "โจ ะะฐัััะพะนะบะฐ ะทะฐะฒะตััะตะฝะฐ!"
echo ""
echo "๐ ะัะพะฒะตัััะต ัะปะตะดัััะตะต:"
echo "1. ะัะฝะพะฒะฝะพะน ัะฐะนั: https://${domain}"
echo "2. ะฃัะปะพะฒะธั ะธัะฟะพะปัะทะพะฒะฐะฝะธั: https://${domain}/terms"
if [[ $use_status_domain == "y" || $use_status_domain == "Y" ]]; then
    echo "3. ะกัะฐััั ัะตัะฒะตัะพะฒ: https://${status_domain}"
else
    echo "3. ะกัะฐััั ัะตัะฒะตัะพะฒ: https://${domain}#status"
fi
echo "4. ะะพั: @pressvpnshop_bot"
echo "5. ะะพะดะดะตัะถะบะฐ: ${support_link}"
echo ""
echo "๐ ะะพะดัะพะฑะฝะฐั ะธะฝััััะบัะธั: docs/SETUP_GUIDE.md"
echo "๐จ HTML ัะฐะฑะปะพะฝั ะฝะฐัะพะดัััั ะฒ ะฐััะตัะฐะบัะฐั ะฒััะต"
