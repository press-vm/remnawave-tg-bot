# Update Deployment Instructions

Этот документ содержит инструкции по развертыванию обновлений из родительской ветки в новую ветку `update-from-upstream-v2`.

## Что было обновлено

### Основные изменения:

1. **Поддержка медиа-сообщений**
   - Рассылки теперь поддерживают фото, видео, аудио, стикеры и другие типы медиа
   - Прямые сообщения администратора пользователям поддерживают все типы контента
   - Новый класс `MessageContent` для унифицированной обработки медиа

2. **Улучшенная работа с датами**
   - Подписки теперь рассчитываются по календарным месяцам, а не по 30 дней
   - Новая утилита `bot/utils/date_utils.py` с функцией `add_months()`

3. **Race-safe создание пользователей**
   - Исправлены проблемы с одновременной регистрацией пользователей
   - PostgreSQL upsert в `user_dal.create_user()`

4. **Webhook-only режим**
   - Отключен polling режим, только webhook
   - Более стабильная работа в продакшене

5. **Улучшенная очередь сообщений**
   - Поддержка всех типов Telegram сообщений
   - Соблюдение лимитов API

## Развертывание

### Вариант 1: Windows
Запустите файл `deploy_updates.bat`

### Вариант 2: Linux/MacOS
Выполните команды из `deploy_updates.sh`:
```bash
chmod +x deploy_updates.sh
./deploy_updates.sh
```

### Вариант 3: Ручное выполнение
```bash
# Переходим в директорию проекта
cd F:/docker/remnawave-tg-bot

# Создаем новую ветку
git checkout -b update-from-upstream-v2

# Добавляем и коммитим изменения
git add .
git commit -m "feat: Update from upstream - major improvements"

# Пушим в новую ветку
git push -u origin update-from-upstream-v2
```

## После развертывания

1. Перейдите на GitHub в ваш репозиторий
2. Создайте Pull Request из ветки `update-from-upstream-v2` в `main`
3. Проведите code review изменений
4. Протестируйте в dev-окружении перед мержем в main

## Breaking Changes

⚠️ **Внимание! Есть breaking changes:**

1. `main_bot.py` теперь требует обязательную настройку webhook-режима
2. `user_dal.create_user()` теперь возвращает кортеж `(user, created)`
3. Длительность подписок рассчитывается по календарным месяцам

## Тестирование

Перед мержем в main рекомендуется протестировать:
- Создание новых пользователей
- Рассылки с разными типами медиа
- Прямые сообщения пользователям
- Создание и продление подписок
- Работу webhook'ов

## Откат изменений

Если что-то пойдет не так, можно вернуться к предыдущей версии:
```bash
git checkout main
git branch -D update-from-upstream-v2  # удалить ветку с обновлениями
```
